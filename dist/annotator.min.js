var Annotation=function t(){var t={annotator:null,_selectedRange:null,range:{startContainerXPath:null,endContainerXPath:null,parentContainerXPath:null,startOffset:null,endOffset:null},id:null,selectedText:null,color:null,note:null,tags:[],init:function(t){if(t)if(t.annotator&&(this.annotator=t.annotator),t.selectedRange)this.saveSelection(t.selectedRange);else if(t.savedAnnotation){var e=t.savedAnnotation;this.range=e.range,this.id=e.id,this.selectedText=e.selectedText,this.color=e.color,this.note=e.note,this.tags=e.tags}},render:function(t){t&&t.temporary?this.wrapNodes(!0):t&&t.convert?this.convertFromTemporary():t&&t.update?this.updateAnnotation():this.wrapNodes()},updateAnnotation:function(){var t=$(this.annotator.findElementByXPath(this.range.parentContainerXPath)),e=t.find(".annotation[data-id='"+this.id+"']");e.removeClass("annotation"),e.removeAttr("class").addClass("annotation").addClass(this.color).removeAttr("style")},saveSelection:function(t){var e=t.commonAncestorContainer,n=t.startContainer,a=t.endContainer,o=t.startOffset,r=t.endOffset,i=this.getParentNodeFor(e),s=this.getParentNodeFor(n),d=this.getParentNodeFor(a),h=this.getNodesToWrap(i,s.firstChild,n),l=this.getNodesToWrap(i,d.firstChild,a);if(h.length)for(var f=0;f<h.length;f++){var c=h[f].nodeValue.length;o+=c}if(l.length)for(var f=0;f<l.length;f++)r+=l[f].nodeValue.length;var g=this.getSelectionContent(t);this._selectedRange=t.cloneRange(),this.range={startContainerXPath:this.annotator.createXPathFromElement(s),endContainerXPath:this.annotator.createXPathFromElement(d),parentContainerXPath:this.annotator.createXPathFromElement(i),startOffset:o,endOffset:r},this.id=this.generateRandomID(),this.selectedText=g},getSelectionContent:function(t){var e=document.createElement("div");e.appendChild(t.cloneContents());var n=e.textContent;return n},getParentNodeFor:function(t){for(;1!=t.nodeType;)t=t.parentNode;return t},generateRandomID:function(){return"annotation-"+(new Date).getTime()},save:function(t){if(t){this.color=t.color,t.note&&(this.note=t.note),t.tags&&t.tags.length&&(this.tags=t.tags);{this.serialize()}t&&t.debug||this.postToRemote(),t&&t.cbk&&t.cbk(this)}},destroy:function(t){t&&t()},postToRemote:function(){},serialize:function(){var t=this.range;return{range:{startOffset:t.startOffset,endOffset:t.endOffset,startContainerXPath:t.startContainerXPath,endContainerXPath:t.endContainerXPath,parentContainerXPath:t.parentContainerXPath},id:this.id,selectedText:this.selectedText,color:this.color,note:this.note,tags:this.tags}},getContainedNodes:function(){var t,e,n,a,o,r,i=[];if(this._selectedRange?(t=this._selectedRange,a=t.commonAncestorContainer,e=t.startContainer,n=t.endContainer):(t=this.range,t.parentContainer=a=this.annotator.findElementByXPath(t.parentContainerXPath),t.startContainer=e=this.annotator.findElementByXPath(t.startContainerXPath),t.endContainer=n=this.annotator.findElementByXPath(t.endContainerXPath)),o=t.startOffset,r=t.endOffset,e.nodeType==Node.ELEMENT_NODE){var s=this.getTextNodeAtOffset(e,o);e=s[0],o-=s[1]}if(n.nodeType==Node.ELEMENT_NODE){var d=this.getTextNodeAtOffset(n,r);n=d[0],r-=d[1]}if(e==n){if(e.nodeType!=Node.ELEMENT_NODE){var h=e.splitText(o);n=h,r-=o;{n.splitText(r)}i.push(n)}}else{if(e.nodeType!=Node.ELEMENT_NODE){var h=e.splitText(o);i.push(h)}if(n.nodeType!=Node.ELEMENT_NODE){{n.splitText(r)}i.push(n)}for(var l=this.getNodesToWrap(a,e.nextSibling,n),f=0;f<l.length;f++)i.push(l[f])}return i},getTextNodeAtOffset:function(t,e){function n(t){if(t.nodeType!=Node.TEXT_NODE||/^\s*$/.test(t.nodeValue)){if(t.nodeType==Node.ELEMENT_NODE)for(var s=0,d=t.childNodes.length;d>s;++s)n(t.childNodes[s])}else o+=t.nodeValue.length,o>=e&&1!=r&&(a=t,i=o-t.nodeValue.length,r=!0)}var a,o=0,r=!1,i=0;return n(t),[a,i]},getNodesToWrap:function(t,e,n){function a(t){if(t==e&&(o=!0),t==n)r=!0;else if(t.nodeType==Node.TEXT_NODE)!o||r||/^\s*$/.test(t.nodeValue)||i.push(t);else for(var s=0,d=t.childNodes.length;!r&&d>s;++s)a(t.childNodes[s])}var o=!1,r=!1,i=[];return a(t),i},wrapNodes:function(t){for(var e=this.getContainedNodes(),n=this.createWrapperElement(t),a=0;a<e.length;a++)$(e[a]).wrap(n)},createWrapperElement:function(t){var e=this.id,n=document.createElement("span");return t?n.classList.add("temporary"):(n.classList.add("annotation"),n.classList.add(this.color)),n.setAttribute("data-id",e),n},removeTemporary:function(){var t,e;this._selectedRange?(t=this._selectedRange,e=t.commonAncestorContainer):(t=this.range,t.parentContainer=e=this.annotator.findElementByXPath(t.parentContainerXPath));for(var n=$(e).find(".temporary"),a=0;a<n.length;a++){var o=n[a];$(o.childNodes[0]).unwrap()}},convertFromTemporary:function(){var t,e;this._selectedRange?(t=this._selectedRange,e=t.commonAncestorContainer):(t=this.range,t.parentContainer=e=this.annotator.findElementByXPath(t.parentContainerXPath));var n=$(e).find(".temporary");n.removeClass("temporary").addClass("annotation").addClass(this.color)}};return t}();
var Editor=function t(){var t={annotator:null,annotation:null,events:[{element:".js-note-form",event:"submit",action:"addNote"},{selector:".js-color-picker",event:"click",action:"setColor"},{selector:".js-copy",event:"click",action:"copyToClipboard"},{selector:".js-share",event:"click",action:"share"},{selector:".js-remove-annotation",event:"click",action:"removeAnnotation"}],init:function(t){this.annotator=t.annotator;var o=$("body");this.$popoverElement=$(this.renderEditorTemplate()),o.append(this.$popoverElement),Awesomplete&&(this._awesomplete=new Awesomplete(this.$popoverElement.find(".js-tags-field")[0])),this.events.forEach(function(t){var o=this;this.$popoverElement.on(t.event,t.selector,function(e){e.preventDefault(),o[t.action].call(o,e)})},this)},renderEditorTemplate:function(){var t='<div id="annotation-editor"><ul class="dropdown-list"><li class="colors">';return this.annotator.colors.forEach(function(o,e){var n="js-color-picker color "+o.className+" "+(0==e?"active":"");t+='<span data-color="'+o.className+'" class="'+n+'"></span>'}),t+='</li><li class="note-input"><form class="js-note-form"><input type="text" class="js-tags-field" placeholder="#revision, #later"><textarea class="js-note-field" placeholder="Add a note..."></textarea><input type="submit" id="add-button" value="Add Note" /></form></li><li><a href="#" class="js-copy">Copy</a></li><li><span class="link">Share</span><ul class="dropdown-list sub-list"><li class="js-facebook-share"><a href="#" class="js-share facebook">Facebook</a></li><li><a href="#" class="js-share twitter">Twitter</a></li></ul></li><li class="js-remove-annotation-wrapper"><a href="#" class="js-remove-annotation">Remove Highlight</a></li></ul></div>'},showEditor:function(t){var o=this.$popoverElement,e=t.position,n=t.annotation,i=t.temporary,a=e.top-30,s=e.left-90;n&&(this.annotation=n,this.activateAnnotationColor(),this.renderContents(),i||this.showRemoveBtn()),window.FB?this.$popoverElement.find(".js-facebook-share").show():this.$popoverElement.find(".js-facebook-share").hide(),i&&this.annotation.render({temporary:!0}),this._awesomplete&&(this._awesomplete.list=this.annotator.tags),o.removeClass("anim").css("top",a-20).css("left",s).show(),setTimeout(function(){o.addClass("anim").css("top",a),o.find("#annotation-input").focus()},0)},isVisible:function(){return this.$popoverElement.is(":visible")},reset:function(){this.annotation.removeTemporary(),this.resetNoteForm(),this.hideRemoveBtn(),this.annotation=null,this.$popoverElement.removeAttr("style")},resetNoteForm:function(){this.$popoverElement.find(".js-note-field, .js-tags-field").val("")},activateAnnotationColor:function(){this.$popoverElement.find(".js-color-picker.active").removeClass("active"),this.$popoverElement.find(".js-color-picker."+(this.annotation.color||"yellow")).addClass("active")},renderContents:function(){this.$popoverElement.find(".js-note-field").val(this.annotation.note),this.annotation.tags&&this.$popoverElement.find(".js-tags-field").val(this.annotation.tags.join(", "))},showRemoveBtn:function(){this.$popoverElement.find(".js-remove-annotation-wrapper").show()},hideRemoveBtn:function(){this.$popoverElement.find(".js-remove-annotation-wrapper").hide()},hideEditor:function(t){this.reset(),this.$popoverElement.hide()},getTagsFromString:function(t){var o=t.split(this.annotator.tagRegex).map(function(t){var o=$.trim(t);return o.length?o:void 0});return o},setColor:function(t){var o=$(t.target),e=o.data("color"),n=this.$popoverElement.find(".js-note-form"),i=n.find(".js-note-field").val(),a=this.getTagsFromString(n.find(".js-tags-field").val());this.saveAndClose({color:e,note:i,tags:a})},addNote:function(t){var o=$(t.target),e=o.find(".js-note-field").val(),n=this.getTagsFromString(o.find(".js-tags-field").val()),i=this.annotation.color||this.annotator.defaultColor;this.saveAndClose({color:i,note:e,tags:n})},saveAndClose:function(t){if(t){var o={debug:this.annotator.debug,cbk:function(t){this.annotator.findAnnotation(t.id)?(this.annotator.updateAnnotation(t.id,t),this.annotation.render({update:!0})):(this.annotation.render({convert:!0}),this.annotator.annotations.push(t)),this.annotator.addTags(t.tags),this.annotator.debug&&this.saveToLocalStorage(),this.hideEditor()}.bind(this)};$.extend(o,t),this.annotation.save(o)}},copyToClipboard:function(){var t=this.annotation.selectedText,o=$("<textarea class='js-hidden-textarea'></textarea>");$(this.annotator.containerElement).append(o),o.val(t).select();try{document.execCommand("copy")}catch(e){}this.hideEditor(),o.remove()},truncate:function(t,o){if(t.length<=o)return t;for(;t.length>=o;)t=t.substr(0,t.lastIndexOf(" "));return t+"..."},removeAnnotation:function(){var t=this.annotation,o=this.annotator;if(t){var e=$(this.annotator.containerElement).find(".annotation[data-id='"+t.id+"']");this.annotation.destroy(function(){o.removeAnnotation(t.id),e.contents().unwrap()}),this.annotator.debug&&this.saveToLocalStorage(),this.hideEditor()}},share:function(t){var o=this.annotation.selectedText,e=$(t.target);if(e.hasClass("facebook")){if(!FB||!FB.ui)return;FB.ui({method:"feed",link:window.location.href,description:o,display:"popup"},function(t){t&&!t.error_code})}else if(e.hasClass("twitter")){var n=575,i=400,a=($(window).width()-n)/2,s=($(window).height()-i)/2,r="status=1,width="+n+",height="+i+",top="+s+",left="+a,l=140-"...".length-window.location.href.length,c="http://twitter.com/share?text="+window.encodeURIComponent(this.truncate(o,l)||"");window.open(c,"Share",r)}this.hideEditor()},saveToLocalStorage:function(){if(window.localStorage){var t=this.annotator.annotations.map(function(t){return t.serialize()});window.localStorage.setItem("annotations",JSON.stringify(t))}}};return t}();
var Annotator=function t(){var t={containerElement:"body",annotations:[],editor:null,defaultColor:"yellow",colors:[{className:"yellow"},{className:"green"},{className:"pink"},{className:"blue"}],tags:[],init:function(t){this.containerElement=t.containerElement||"body",this.debug=t.debug||"true",this.remoteURL=t.remoteURL||"",t.existingTags&&(this.tags=t.existingTags),t.colors&&(this.colors=t.colors),t.annotations&&this.renderExistingAnnotations(t.annotations);var n=Object.create(Editor);n.init({annotator:this}),this.setEditor(n)},addTags:function(t){this.tags=this.tags.concat(t)},setEditor:function(t){this.editor=t},findAnnotation:function(t){return this.annotations.filter(function(n){return n.id==t})[0]},updateAnnotation:function(t,n){var i=this.annotations.map(function(t){return t.id}).indexOf(t);-1>=i||(this.annotations[i]=n)},removeAnnotation:function(t){var n=this.annotations.map(function(t){return t.id}).indexOf(t);-1>=n||this.annotations.splice(n,1)},renderExistingAnnotations:function(t){for(var n=0;n<t.length;n++){var i=Object.create(Annotation);i.init({savedAnnotation:t[n],annotator:this}),i.render(),this.annotations.push(i)}},handleAnnotationClick:function(t){var n=$(t.target),i=n.data("id"),e=this.findAnnotation(i);window.ann=e,e&&this.editor.showEditor({position:{top:t.pageY,left:t.pageX},annotation:e})},handleAnnotation:function(t){var n,i=window.getSelection();if(n=i.text?i.text:i.toString(),i&&!i.isCollapsed&&n&&n.length>5){var e=i.getRangeAt(0),o=Object.create(Annotation);o.init({selectedRange:e,annotator:this});{({top:t.pageY,left:t.pageX})}this.editor.showEditor({position:{top:t.pageY,left:t.pageX},annotation:o,temporary:!0})}},startListening:function(){var t=$(this.containerElement),n=this;t.on("click",".annotation",function(t){t.stopPropagation(),n.handleAnnotationClick(t)}),t.on("mouseup touchend",function(t){t.preventDefault();var i=$(t.target);!n.editor.isVisible()||i.parents("#annotation-editor").length||i.hasClass("annotation")||n.editor.hideEditor(),n.handleAnnotation(t)})},findElementByXPath:function(t){var n=new XPathEvaluator,i=n.evaluate(t,document.documentElement,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null);return i.singleNodeValue},createXPathFromElement:function(t){for(var n=document.getElementsByTagName("*"),e=[];t&&1==t.nodeType;t=t.parentNode)if(t.hasAttribute("id")){for(var o=0,a=0;a<n.length&&(n[a].hasAttribute("id")&&n[a].id==t.id&&o++,!(o>1));a++);if(1==o)return e.unshift('id("'+t.getAttribute("id")+'")'),e.join("/");e.unshift(t.localName.toLowerCase()+'[@id="'+t.getAttribute("id")+'"]')}else if(t.hasAttribute("class"))e.unshift(t.localName.toLowerCase()+'[@class="'+t.getAttribute("class")+'"]');else{for(i=1,sib=t.previousSibling;sib;sib=sib.previousSibling)sib.localName==t.localName&&i++;e.unshift(t.localName.toLowerCase()+"["+i+"]")}return e.length?"/"+e.join("/"):null}};return t}();